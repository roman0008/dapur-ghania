<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dapur Ghania - Catering & Snack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .nav-active { color: #ea580c !important; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .modal-blur { backdrop-filter: blur(8px); background: rgba(0,0,0,0.4); }
        .tab-btn.active { border-bottom: 2px solid #ea580c; color: #ea580c; }
    </style>
</head>
<body class="bg-[#FFFAF5] text-gray-800">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 z-[999] hidden items-center justify-center modal-blur">
        <div class="bg-white p-8 rounded-3xl shadow-xl text-center">
            <div class="animate-spin text-orange-600 text-3xl mb-4"><i class="fas fa-circle-notch"></i></div>
            <p id="loader-text" class="text-xs font-bold text-gray-600 uppercase tracking-widest">Memproses...</p>
        </div>
    </div>

    <!-- Header / Navbar -->
    <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="font-black text-orange-800 tracking-tighter text-xl">DAPUR GHANIA</h1>
            
            <div class="flex items-center gap-3">
                <button class="relative p-2 text-gray-600">
                    <i class="fas fa-shopping-basket text-xl"></i>
                    <span id="cart-count" class="absolute top-0 right-0 bg-orange-600 text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full font-bold">0</span>
                </button>

                <div id="auth-controls">
                    <button onclick="openLoginModal()" class="flex items-center gap-2 bg-orange-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:bg-orange-700 transition-all">
                        <i class="fas fa-user-circle text-base"></i>
                        <span>MASUK</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal Login (Popup) -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-blur">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="auth-title" class="text-xl font-black text-gray-900">Member Area</h2>
                    <button onclick="closeLoginModal()" class="text-gray-300 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>

                <div id="login-form" class="space-y-4">
                    <input type="tel" id="login-phone" placeholder="No. WhatsApp" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-orange-500 font-bold">
                    <input type="password" id="login-pin" placeholder="PIN 6 Digit" maxlength="6" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-orange-500 text-center tracking-[0.5em] font-bold">
                    <button onclick="handleLogin()" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Masuk Sekarang</button>
                    <div class="flex justify-between px-2">
                        <button onclick="toggleAuthType('register')" class="text-orange-600 text-[10px] font-bold uppercase">Daftar Baru</button>
                        <button onclick="toggleAuthType('admin')" class="text-gray-400 text-[10px] font-bold uppercase">Admin Login</button>
                    </div>
                </div>

                <div id="register-form" class="hidden space-y-4">
                    <input type="text" id="reg-name" placeholder="Nama Lengkap" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-orange-500 font-bold">
                    <input type="tel" id="reg-phone" placeholder="No. WhatsApp" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-orange-500 font-bold">
                    <input type="password" id="reg-pin" placeholder="PIN 6 Digit" maxlength="6" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-orange-500 text-center tracking-[0.5em] font-bold">
                    <button onclick="handleRegister()" class="w-full bg-orange-950 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Daftar Akun</button>
                    <button onclick="toggleAuthType('login')" class="w-full text-gray-400 text-[10px] font-bold uppercase">Kembali Masuk</button>
                </div>

                <div id="admin-form" class="hidden space-y-4">
                    <div class="bg-red-50 p-2 rounded-xl text-center text-[10px] text-red-600 font-bold mb-2 tracking-widest uppercase">Akses Administrator</div>
                    <input type="tel" id="admin-phone" placeholder="ID Admin" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-red-500 font-bold">
                    <input type="password" id="admin-pin" placeholder="PIN Rahasia" maxlength="6" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:outline-red-500 text-center tracking-[0.5em] font-bold">
                    <button onclick="handleAdminLogin()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold">Login Admin</button>
                    <button onclick="toggleAuthType('login')" class="w-full text-gray-400 text-[10px] font-bold uppercase">Kembali</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <main class="max-w-4xl mx-auto pb-24">
        <section id="page-shop" class="page-content p-4 space-y-6">
            <div class="bg-orange-600 rounded-[2.5rem] p-8 text-white card-shadow relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-3xl font-black leading-tight mb-4">Makan Enak<br>Tanpa Ribet!</h2>
                    <p class="text-orange-100 text-sm mb-6 max-w-[200px]">Catering tradisional & snack box premium pilihan keluarga.</p>
                </div>
                <i class="fas fa-cookie-bite absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
            </div>
            <div class="grid grid-cols-2 gap-4" id="product-list"></div>
        </section>

        <section id="page-history" class="page-content hidden p-4">
            <div id="history-header" class="mb-6">
                <h2 class="text-xl font-black text-orange-950">Pesanan Saya</h2>
                <div class="flex mt-4 bg-white rounded-2xl p-1 shadow-sm border border-gray-100">
                    <button onclick="switchHistoryTab('unpaid')" id="tab-unpaid" class="tab-btn active flex-1 py-3 text-[10px] font-black uppercase">Belum Bayar</button>
                    <button onclick="switchHistoryTab('paid')" id="tab-paid" class="tab-btn flex-1 py-3 text-[10px] font-black text-gray-400 uppercase">Riwayat Lunas</button>
                </div>
            </div>
            <div id="order-container" class="space-y-4"></div>
        </section>

        <section id="page-admin" class="page-content hidden p-4">
            <h2 class="text-xl font-black text-red-700 mb-6 text-center">Admin Panel</h2>
            <div id="admin-container" class="space-y-4"></div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t p-3 flex justify-around items-center z-50">
        <button onclick="showPage('shop')" id="nav-shop" class="flex flex-col items-center gap-1 nav-active transition-all">
            <i class="fas fa-home text-xl"></i>
            <span class="text-[9px] font-bold uppercase">Beranda</span>
        </button>
        <button onclick="showPage('history')" id="nav-history" class="flex flex-col items-center gap-1 text-gray-300 transition-all">
            <i class="fas fa-receipt text-xl"></i>
            <span class="text-[9px] font-bold uppercase">Pesanan</span>
        </button>
        <button onclick="showPage('admin')" id="nav-admin" class="hidden flex flex-col items-center gap-1 text-gray-300 transition-all">
            <i class="fas fa-shield-alt text-xl"></i>
            <span class="text-[9px] font-bold uppercase">Admin</span>
        </button>
    </nav>

<script>
    // PASTIKAN URL INI ADALAH URL DEPLOYMENT /EXEC TERBARU ANDA
    const GSHEET_URL = "https://script.google.com/macros/s/AKfycbxxh84nTLVhDokvfosJ9VGm7_dY_HY26ixIsn0D0VJ7LKrqqvNUP5KpAbS9geKetiknXQ/exec";
    
    let currentUser = JSON.parse(localStorage.getItem('ghania_session'));
    let isAdmin = localStorage.getItem('ghania_role') === 'admin';
    let currentHistoryTab = 'unpaid';

    const PRODUCTS = [
        { id: 1, name: "Nasi Box Ayam Bakar", price: 25000, img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400" },
        { id: 2, name: "Snack Box Premium", price: 15000, img: "https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?w=400" },
        { id: 3, name: "Nasi Tumpeng Mini", price: 35000, img: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400" },
        { id: 4, name: "Kue Tampah Sedang", price: 150000, img: "https://images.unsplash.com/photo-1563729784474-d77dbb933a9e?w=400" }
    ];

    function openLoginModal() {
        if(currentUser) {
            if(confirm("Halo " + currentUser.name + ", ingin keluar akun?")) handleLogout();
            return;
        }
        document.getElementById('login-modal').classList.remove('hidden');
    }

    function closeLoginModal() {
        document.getElementById('login-modal').classList.add('hidden');
    }

    function toggleAuthType(type) {
        document.getElementById('login-form').classList.toggle('hidden', type !== 'login');
        document.getElementById('register-form').classList.toggle('hidden', type !== 'register');
        document.getElementById('admin-form').classList.toggle('hidden', type !== 'admin');
        document.getElementById('auth-title').innerText = type === 'admin' ? 'Administrator' : (type === 'register' ? 'Daftar Member' : 'Member Area');
    }

    function showPage(pageId) {
        if((pageId === 'history' || pageId === 'admin') && !currentUser) {
            alert("Harap login terlebih dahulu.");
            openLoginModal();
            return;
        }
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${pageId}`).classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
        document.getElementById(`nav-${pageId}`)?.classList.add('nav-active');

        if(pageId === 'history') loadMemberOrders();
        if(pageId === 'admin') loadAdminOrders();
    }

    function handleLogin() {
        const phone = formatPhone(document.getElementById('login-phone').value);
        const pin = document.getElementById('login-pin').value;
        if(!phone || !pin) return alert("Nomor HP dan PIN wajib diisi!");
        
        showLoader(true, "Verifikasi Member...");
        
        const loginTimeout = setTimeout(() => {
            showLoader(false);
            alert("Koneksi gagal atau script tidak merespon. Cek URL Deployment Anda.");
        }, 15000);

        requestJSONP(`${GSHEET_URL}?action=login&phone=${phone}&pin=${pin}`, (res) => {
            clearTimeout(loginTimeout);
            showLoader(false);
            if(res && res.success) {
                currentUser = { phone, name: res.name };
                localStorage.setItem('ghania_session', JSON.stringify(currentUser));
                localStorage.setItem('ghania_role', 'member');
                isAdmin = false;
                closeLoginModal();
                updateUI();
                showPage('shop');
            } else { 
                alert(res ? res.message : "Gagal terhubung ke server."); 
            }
        });
    }

    function handleRegister() {
        const name = document.getElementById('reg-name').value;
        const phone = formatPhone(document.getElementById('reg-phone').value);
        const pin = document.getElementById('reg-pin').value;
        
        if(!name || !phone || !pin) return alert("Harap lengkapi semua data pendaftaran!");
        if(pin.length !== 6) return alert("PIN harus 6 digit angka!");

        showLoader(true, "Mendaftarkan Akun...");

        const regTimeout = setTimeout(() => {
            showLoader(false);
            alert("Koneksi gagal atau script tidak merespon.");
        }, 15000);

        requestJSONP(`${GSHEET_URL}?action=register&name=${encodeURIComponent(name)}&phone=${phone}&pin=${pin}`, (res) => {
            clearTimeout(regTimeout);
            showLoader(false);
            if(res && res.success) {
                alert("Pendaftaran Berhasil! Silakan Login.");
                toggleAuthType('login');
            } else {
                alert(res ? res.message : "Gagal mendaftarkan akun.");
            }
        });
    }

    function handleAdminLogin() {
        const phone = document.getElementById('admin-phone').value;
        const pin = document.getElementById('admin-pin').value;
        if(!phone || !pin) return alert("ID dan PIN Admin wajib diisi!");

        showLoader(true, "Otentikasi Admin...");
        requestJSONP(`${GSHEET_URL}?action=loginAdmin&phone=${phone}&pin=${pin}`, (res) => {
            showLoader(false);
            if(res && res.success) {
                currentUser = { phone, name: "Administrator" };
                isAdmin = true;
                localStorage.setItem('ghania_session', JSON.stringify(currentUser));
                localStorage.setItem('ghania_role', 'admin');
                closeLoginModal();
                updateUI();
                showPage('admin');
            } else { alert("Akses Ditolak: PIN Admin Salah."); }
        });
    }

    function handleLogout() {
        localStorage.clear();
        location.reload();
    }

    function updateUI() {
        const authBtn = document.querySelector('#auth-controls button');
        const bottomNav = document.getElementById('bottom-nav');
        const navAdmin = document.getElementById('nav-admin');

        if(currentUser) {
            authBtn.innerHTML = `<i class="fas fa-user-check"></i> <span>${currentUser.name.split(' ')[0]}</span>`;
            authBtn.className = "flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-xs font-bold";
            bottomNav.classList.remove('hidden');
            if(isAdmin) navAdmin.classList.remove('hidden');
        }
    }

    function renderProducts() {
        const container = document.getElementById('product-list');
        container.innerHTML = PRODUCTS.map(p => `
            <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-gray-50 flex flex-col card-shadow">
                <img src="${p.img}" class="h-40 w-full object-cover">
                <div class="p-4 flex-1 flex flex-col">
                    <h4 class="font-bold text-sm mb-1">${p.name}</h4>
                    <p class="text-orange-600 font-black text-sm mb-4">Rp ${p.price.toLocaleString()}</p>
                    <button onclick="alert('Pesanan diteruskan ke Admin...')" class="mt-auto w-full bg-orange-50 text-orange-600 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-600 hover:text-white transition-all">Tambah</button>
                </div>
            </div>
        `).join('');
    }

    function loadMemberOrders() {
        const container = document.getElementById('order-container');
        container.innerHTML = `<div class="text-center py-10"><i class="fas fa-circle-notch animate-spin text-orange-600"></i></div>`;
        requestJSONP(`${GSHEET_URL}?action=getOrders&phone=${currentUser.phone}`, (res) => {
            const data = res.data || [];
            const filtered = data.filter(o => {
                const s = (o.status_bayar || "").toLowerCase();
                const isL = s === 'paid' || s === 'lunas';
                return currentHistoryTab === 'paid' ? isL : !isL;
            });
            renderOrderCards(container, filtered, false);
        });
    }

    function loadAdminOrders() {
        const container = document.getElementById('admin-container');
        container.innerHTML = `<div class="text-center py-10"><i class="fas fa-circle-notch animate-spin text-red-600"></i></div>`;
        requestJSONP(`${GSHEET_URL}?action=getAllOrders`, (res) => {
            const unpaid = (res.data || []).filter(o => !['paid', 'lunas'].includes((o.status_bayar || "").toLowerCase()));
            renderOrderCards(container, unpaid, true);
        });
    }

    function renderOrderCards(container, data, isAdminView) {
        if(data.length === 0) {
            container.innerHTML = `<p class="text-center py-10 text-[10px] font-bold text-gray-300 uppercase">Tidak ada data ditemukan</p>`;
            return;
        }
        container.innerHTML = data.map(o => {
            const isLunas = (o.status_bayar || "").toLowerCase() === 'lunas' || (o.status_bayar || "").toLowerCase() === 'paid';
            return `
            <div class="bg-white p-5 rounded-[1.5rem] border border-gray-100 shadow-sm relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="text-[9px] font-black text-orange-600 bg-orange-50 px-2 py-1 rounded-md">#${o.invoice}</span>
                        <p class="text-[9px] text-gray-400 mt-1 font-bold">${o.date}</p>
                    </div>
                    <span class="text-[8px] font-black px-2 py-1 rounded-full uppercase ${isLunas ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${o.status_bayar}
                    </span>
                </div>
                ${isAdminView ? `<p class="text-[10px] font-bold mb-1">${o.name}</p>` : ''}
                <h4 class="font-bold text-xs text-gray-600 mb-3">${o.items}</h4>
                <div class="flex justify-between items-center pt-3 border-t border-dashed border-gray-100">
                    <span class="text-[10px] text-gray-400 font-bold uppercase">Total</span>
                    <span class="text-sm font-black text-orange-700">Rp ${Number(o.total || 0).toLocaleString()}</span>
                </div>
                ${isAdminView && !isLunas ? `<button onclick="updateStatus('${o.rowId}')" class="w-full mt-3 bg-green-600 text-white py-2 rounded-xl text-[10px] font-bold">KONFIRMASI LUNAS</button>` : ''}
            </div>
        `}).join('');
    }

    function updateStatus(rowId) {
        if(!confirm("Tandai pesanan ini Lunas?")) return;
        showLoader(true, "Updating...");
        requestJSONP(`${GSHEET_URL}?action=updateStatus&rowId=${rowId}&status=Lunas`, (res) => {
            showLoader(false);
            if(res.success) loadAdminOrders();
        });
    }

    function switchHistoryTab(tab) {
        currentHistoryTab = tab;
        document.getElementById('tab-unpaid').className = `tab-btn flex-1 py-3 text-[10px] font-black ${tab === 'unpaid' ? 'active' : 'text-gray-400'}`;
        document.getElementById('tab-paid').className = `tab-btn flex-1 py-3 text-[10px] font-black ${tab === 'paid' ? 'active' : 'text-gray-400'}`;
        loadMemberOrders();
    }

    function formatPhone(num) {
        if(!num) return "";
        let clean = num.toString().replace(/\D/g, '');
        if (clean.startsWith('0')) clean = '62' + clean.substring(1);
        if (clean.startsWith('8')) clean = '62' + clean;
        return clean;
    }

    function requestJSONP(url, callback) {
        const cbName = 'ghania_cb_' + Math.round(Math.random() * 1000000);
        window[cbName] = (res) => { 
            callback(res); 
            document.getElementById(cbName)?.remove(); 
            delete window[cbName]; 
        };
        const s = document.createElement('script'); 
        s.id = cbName; 
        s.src = `${url}${url.includes('?') ? '&' : '?'}callback=${cbName}`;
        
        s.onerror = () => {
            showLoader(false);
            alert("Gagal memuat data dari Google Script. Periksa izin akses Web App Anda (Set to: Anyone).");
            document.getElementById(cbName)?.remove();
            delete window[cbName];
        };
        document.body.appendChild(s);
    }

    function showLoader(v, t) {
        const l = document.getElementById('loader');
        const lt = document.getElementById('loader-text');
        l.classList.toggle('hidden', !v);
        l.classList.toggle('flex', v);
        lt.innerText = t;
    }

    window.onload = () => {
        renderProducts();
        updateUI();
    };
</script>
</body>
</html>
