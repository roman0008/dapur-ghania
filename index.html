import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  updateProfile,
  signOut,
  signInAnonymously,
  signInWithCustomToken
} from 'firebase/auth';
import { ShoppingBag, User, LogIn, X, Plus, Minus, Loader2, CheckCircle2, Info, AlertCircle } from 'lucide-react';

// --- Konfigurasi Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'dapur-ghania-web';

export default function App() {
  const [user, setUser] = useState(null);
  const [cart, setCart] = useState([]);
  const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [authTab, setAuthTab] = useState('login');
  const [loading, setLoading] = useState(false);
  const [toast, setToast] = useState(null);
  
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');

  const products = {
    simple: [
      { id: 1, name: "Onde Onde Premium", price: 80000, img: "https://i.pinimg.com/736x/1c/ad/0f/1cad0f0468d08ec7360bcdbb1b091530.jpg" },
      { id: 2, name: "Pastel Gurih (10 Pcs)", price: 90000, img: "https://i.pinimg.com/736x/3b/e3/29/3be329a4dbee5bb31b925b09b6e6b257.jpg" },
      { id: 3, name: "Sosis Solo Box", price: 75000, img: "https://i.pinimg.com/736x/e6/52/78/e65278783688669e4695027581b2a9d6.jpg" }
    ],
    exclusive: [
      { id: 10, name: "Pudding Art Special", price: 175000, img: "https://images.unsplash.com/photo-1551024506-0bccd828d307?w=400" },
      { id: 11, name: "Exclusive Gift Box", price: 250000, img: "https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=400" },
      { id: 12, name: "Hampers Hari Raya", price: 350000, img: "https://images.unsplash.com/photo-1544476073-42ca5185966d?w=400" }
    ]
  };

  // Efek Autentikasi yang Diperkuat
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          // Gunakan Anonim jika login biasa belum diatur di Firebase Console
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Init Error:", err);
      }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  const showToast = (msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 4000);
  };

  const handleAuth = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      if (authTab === 'login') {
        await signInWithEmailAndPassword(auth, email, password);
        showToast("Selamat datang kembali!");
      } else {
        const res = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(res.user, { displayName: name });
        showToast("Akun berhasil dibuat!");
      }
      setIsAuthModalOpen(false);
    } catch (err) {
      // Jika error karena metode belum aktif di dashboard
      if (err.code === 'auth/operation-not-allowed') {
        showToast("Metode Login Email belum diaktifkan di Firebase Console. Menggunakan mode tamu.", 'error');
      } else {
        showToast(err.message, 'error');
      }
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = async () => {
    if (window.confirm("Keluar dari akun?")) {
      await signOut(auth);
      // Login kembali secara anonim agar aplikasi tidak kosong
      await signInAnonymously(auth);
      showToast("Berhasil Logout");
    }
  };

  const addToCart = (product) => {
    setCart(prev => {
      const existing = prev.find(item => item.id === product.id);
      if (existing) return prev.map(item => item.id === product.id ? { ...item, qty: item.qty + 1 } : item);
      return [...prev, { ...product, qty: 1 }];
    });
    showToast(`âœ“ ${product.name} masuk keranjang`);
  };

  const updateQty = (id, delta) => {
    setCart(prev => prev.map(item => {
      if (item.id === id) return { ...item, qty: Math.max(0, item.qty + delta) };
      return item;
    }).filter(item => item.qty > 0));
  };

  const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
  const discOngkir = (subtotal >= 1200000) ? 50000 : 0;
  // Jika user bukan anonim, anggap dia member premium
  const isRealUser = user && !user.isAnonymous;
  const discMember = (isRealUser && subtotal >= 500000) ? 20000 : 0;
  const finalTotal = subtotal - (discOngkir + discMember);

  return (
    <div className="min-h-screen bg-[#fdfaf7] font-sans pb-24 text-slate-900 selection:bg-orange-100">
      {/* Header */}
      <header className="bg-white/80 backdrop-blur-md sticky top-0 z-40 shadow-sm border-b border-orange-50">
        <div className="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-black text-[#3E2723] tracking-tighter">DAPUR <span className="text-orange-600">GHANIA</span></h1>
            <p className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Premium Homemade Catering</p>
          </div>
          <div className="flex items-center gap-4">
            {(!user || user.isAnonymous) ? (
              <button 
                onClick={() => setIsAuthModalOpen(true)}
                className="flex items-center gap-2 text-xs font-bold text-[#3E2723] bg-[#efebe9] px-5 py-2.5 rounded-full hover:bg-[#e0d9d5] transition-all active:scale-95"
              >
                <LogIn size={16} /> Login Member
              </button>
            ) : (
              <div className="flex items-center gap-3 cursor-pointer group" onClick={handleLogout}>
                <div className="text-right hidden sm:block">
                  <p className="text-[10px] font-bold text-orange-600 uppercase">Premium Member</p>
                  <p className="text-sm font-bold text-[#3E2723]">{user.displayName || user.email?.split('@')[0]}</p>
                </div>
                <img 
                  src={`https://ui-avatars.com/api/?name=${user.displayName || user.email}&background=3E2723&color=fff`} 
                  className="w-10 h-10 rounded-full border-2 border-orange-200 group-hover:border-orange-500 transition-all shadow-sm"
                />
              </div>
            )}
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-6xl mx-auto p-4 md:p-8 space-y-12">
        {/* Banner Hero */}
        <section className="bg-[#3E2723] rounded-[2.5rem] p-8 md:p-12 text-white relative overflow-hidden shadow-2xl">
          <div className="relative z-10 max-w-xl">
            <div className="inline-flex items-center gap-2 bg-orange-600 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-6">
              <CheckCircle2 size={12} /> Terverifikasi Halal
            </div>
            <h2 className="text-4xl md:text-5xl font-black mb-6 leading-tight">Catering Premium Untuk Momen Spesial Anda.</h2>
            <p className="text-orange-100/80 text-base mb-8 font-medium leading-relaxed">Pesan hari ini dan dapatkan diskon ongkir hingga Rp 50.000. Rasakan kelezatan masakan rumah dengan standar bintang lima.</p>
            <button className="bg-white text-[#3E2723] px-8 py-4 rounded-2xl font-black hover:bg-orange-50 transition-colors shadow-lg shadow-black/20">
              Lihat Menu Spesial
            </button>
          </div>
          <div className="absolute -bottom-20 -right-20 w-80 h-80 bg-orange-600/20 rounded-full blur-3xl"></div>
        </section>

        {/* Product Sections */}
        {['simple', 'exclusive'].map(cat => (
          <section key={cat}>
            <div className="flex justify-between items-end mb-10">
              <div>
                <h3 className="font-black text-3xl text-[#3E2723] mb-2 uppercase tracking-tight">
                  {cat === 'simple' ? 'Menu Simple Box' : 'Exclusive Collection'}
                </h3>
                <div className="h-1.5 w-20 bg-orange-600 rounded-full"></div>
              </div>
              <span className="hidden sm:block text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] border-b-2 border-slate-100 pb-1">
                Premium Selection
              </span>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
              {products[cat].map(p => (
                <div key={p.id} className="bg-white rounded-[2.5rem] overflow-hidden border border-orange-50 shadow-sm hover:shadow-2xl transition-all duration-500 group flex flex-col translate-y-0 hover:-translate-y-2">
                  <div className="aspect-[4/3] overflow-hidden bg-slate-100 relative">
                    <img 
                      src={p.img} 
                      alt={p.name} 
                      className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                    />
                    <div className="absolute bottom-4 left-4 bg-white/90 backdrop-blur-md px-4 py-2 rounded-2xl shadow-lg border border-white">
                      <p className="text-sm font-black text-[#3E2723]">Rp {p.price.toLocaleString()}</p>
                    </div>
                  </div>
                  <div className="p-8 flex flex-col flex-grow">
                    <h4 className="font-black text-slate-800 mb-3 uppercase text-base tracking-tight leading-tight">{p.name}</h4>
                    <p className="text-xs text-slate-500 mb-8 flex-grow leading-relaxed">Paket lengkap yang disiapkan secara higienis menggunakan resep turun temurun khas Dapur Ghania.</p>
                    <button 
                      onClick={() => addToCart(p)}
                      className="w-full py-4 bg-[#fdf2f0] text-orange-700 rounded-2xl font-black flex items-center justify-center gap-3 hover:bg-[#3E2723] hover:text-white transition-all active:scale-95 group/btn shadow-sm"
                    >
                      <Plus size={20} strokeWidth={3} className="group-hover/btn:rotate-90 transition-transform" /> 
                      TAMBAH KE BOX
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        ))}
      </main>

      {/* Floating Cart Bar */}
      <div className="fixed bottom-8 left-0 right-0 px-6 pointer-events-none z-50">
        <div 
          onClick={() => setIsCartOpen(true)}
          className="max-w-lg mx-auto bg-[#3E2723] text-white p-5 rounded-[2rem] flex justify-between items-center shadow-2xl cursor-pointer pointer-events-auto hover:scale-[1.03] transition-all ring-4 ring-white/10 active:scale-95"
        >
          <div className="flex items-center gap-5">
            <div className="bg-orange-600 p-4 rounded-2xl relative shadow-inner">
              <ShoppingBag size={24} />
              {cart.length > 0 && (
                <span className="absolute -top-3 -right-3 bg-white text-[#3E2723] text-xs w-7 h-7 flex items-center justify-center rounded-full font-black border-4 border-orange-600 shadow-xl">
                  {cart.reduce((s, i) => s + i.qty, 0)}
                </span>
              )}
            </div>
            <div>
              <p className="text-xs font-black text-orange-200 uppercase tracking-widest">Total Pesanan</p>
              <p className="text-lg font-black text-white leading-none">Rp {finalTotal.toLocaleString()}</p>
            </div>
          </div>
          <div className="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest border border-white/10">
            Cek Detail
          </div>
        </div>
      </div>

      {/* Auth Modal */}
      {isAuthModalOpen && (
        <div className="fixed inset-0 bg-[#3E2723]/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-md rounded-[3rem] overflow-hidden shadow-2xl">
            <div className="p-2 flex bg-slate-50 m-6 rounded-[2rem]">
              <button 
                onClick={() => setAuthTab('login')}
                className={`flex-1 py-4 text-xs font-black rounded-[1.5rem] transition-all uppercase tracking-widest ${authTab === 'login' ? 'bg-white shadow-md text-[#3E2723]' : 'text-slate-400'}`}
              >
                Masuk
              </button>
              <button 
                onClick={() => setAuthTab('register')}
                className={`flex-1 py-4 text-xs font-black rounded-[1.5rem] transition-all uppercase tracking-widest ${authTab === 'register' ? 'bg-white shadow-md text-[#3E2723]' : 'text-slate-400'}`}
              >
                Daftar
              </button>
            </div>
            <form onSubmit={handleAuth} className="px-10 pb-10 space-y-5">
              <div className="text-center mb-8">
                <h3 className="text-2xl font-black text-slate-800 mb-2 uppercase tracking-tight">Akun Member</h3>
                <p className="text-xs text-slate-400 font-medium">Masuk untuk menikmati potongan harga member.</p>
              </div>
              
              {authTab === 'register' && (
                <input 
                  type="text" placeholder="Nama Lengkap" 
                  className="w-full p-5 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-orange-200 outline-none transition-all font-bold"
                  value={name} onChange={e => setName(e.target.value)} required
                />
              )}
              <input 
                type="email" placeholder="Email" 
                className="w-full p-5 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-orange-200 outline-none transition-all font-bold"
                value={email} onChange={e => setEmail(e.target.value)} required
              />
              <input 
                type="password" placeholder="Password" 
                className="w-full p-5 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-orange-200 outline-none transition-all font-bold"
                value={password} onChange={e => setPassword(e.target.value)} required
              />
              <button 
                type="submit" disabled={loading}
                className="w-full py-5 bg-orange-600 text-white rounded-2xl font-black shadow-xl hover:bg-[#3E2723] transition-all flex items-center justify-center gap-2 uppercase tracking-widest text-xs"
              >
                {loading ? <Loader2 className="animate-spin" /> : (authTab === 'login' ? 'Masuk Sekarang' : 'Daftar Akun')}
              </button>
              <button 
                type="button" onClick={() => setIsAuthModalOpen(false)}
                className="w-full text-slate-300 text-[10px] font-black uppercase tracking-widest pt-2"
              >
                Batal
              </button>
            </form>
          </div>
        </div>
      )}

      {/* Cart Drawer */}
      {isCartOpen && (
        <div className="fixed inset-0 bg-[#3E2723]/60 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4">
          <div className="bg-white w-full max-w-lg rounded-t-[3rem] sm:rounded-[3rem] max-h-[95vh] flex flex-col shadow-2xl">
            <div className="p-10 pb-6 flex justify-between items-center border-b border-orange-50">
              <h3 className="text-3xl font-black text-[#3E2723] uppercase tracking-tighter">Box Pesanan</h3>
              <button onClick={() => setIsCartOpen(false)} className="p-3 bg-slate-50 rounded-full text-slate-400 hover:rotate-90 transition-transform">
                <X size={24} />
              </button>
            </div>

            <div className="flex-grow overflow-y-auto p-10 space-y-6">
              {cart.length === 0 ? (
                <div className="text-center py-20 opacity-30">
                  <ShoppingBag size={80} className="mx-auto mb-6" />
                  <p className="font-black text-xl uppercase tracking-tighter">Box Kosong</p>
                </div>
              ) : (
                cart.map(item => (
                  <div key={item.id} className="flex items-center gap-6 bg-slate-50/50 p-5 rounded-[2rem] border border-orange-50">
                    <img src={item.img} className="w-20 h-20 rounded-2xl object-cover shadow-md" />
                    <div className="flex-grow">
                      <p className="text-sm font-black text-[#3E2723] uppercase leading-tight mb-1">{item.name}</p>
                      <p className="text-xs text-orange-600 font-bold tracking-widest">Rp {item.price.toLocaleString()}</p>
                    </div>
                    <div className="flex items-center gap-4 bg-white p-3 rounded-2xl shadow-sm">
                      <button onClick={() => updateQty(item.id, -1)} className="text-orange-600 hover:scale-125 transition-transform"><Minus size={18} strokeWidth={3} /></button>
                      <span className="font-black text-base w-5 text-center">{item.qty}</span>
                      <button onClick={() => updateQty(item.id, 1)} className="text-orange-600 hover:scale-125 transition-transform"><Plus size={18} strokeWidth={3} /></button>
                    </div>
                  </div>
                ))
              )}
            </div>

            {cart.length > 0 && (
              <div className="p-10 bg-[#3E2723] rounded-t-[3rem]">
                <div className="space-y-3 mb-8">
                  <div className="flex justify-between text-[10px] font-black text-orange-200/50 uppercase tracking-[0.2em]">
                    <span>Subtotal Menu</span>
                    <span>Rp {subtotal.toLocaleString()}</span>
                  </div>
                  {(discOngkir > 0 || discMember > 0) && (
                    <div className="bg-white/5 p-4 rounded-2xl border border-white/10 space-y-2">
                      {discOngkir > 0 && (
                        <div className="flex justify-between text-[10px] font-black text-emerald-400 uppercase tracking-widest">
                          <span>Potongan Ongkir Premium</span>
                          <span>- Rp {discOngkir.toLocaleString()}</span>
                        </div>
                      )}
                      {discMember > 0 && (
                        <div className="flex justify-between text-[10px] font-black text-emerald-400 uppercase tracking-widest">
                          <span>Reward Member Premium</span>
                          <span>- Rp {discMember.toLocaleString()}</span>
                        </div>
                      )}
                    </div>
                  )}
                  {(!user || user.isAnonymous) && (
                    <div className="flex items-center gap-3 text-[9px] text-orange-200 font-black bg-white/5 p-3 rounded-xl border border-white/10">
                      <Info size={14} className="text-orange-500" />
                      <span className="uppercase tracking-widest">Login member untuk diskon tambahan Rp 20.000!</span>
                    </div>
                  )}
                  <div className="flex justify-between items-center pt-6 border-t border-white/10">
                    <span className="text-xs font-black text-white uppercase tracking-[0.3em]">Total Bayar</span>
                    <span className="text-3xl font-black text-orange-500">Rp {finalTotal.toLocaleString()}</span>
                  </div>
                </div>
                <button 
                  onClick={() => showToast("Pesanan diterima! Admin akan segera menghubungi WhatsApp Anda.")}
                  className="w-full py-6 bg-orange-600 text-white rounded-2xl font-black text-sm shadow-2xl hover:bg-white hover:text-orange-600 transition-all uppercase tracking-[0.2em]"
                >
                  Konfirmasi Pesanan
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Toast Notification */}
      {toast && (
        <div className={`fixed top-10 left-1/2 -translate-x-1/2 px-8 py-5 rounded-full font-black shadow-2xl z-[200] flex items-center gap-3 animate-in fade-in slide-in-from-top-10 duration-500 text-xs uppercase tracking-widest border-2 ${
          toast.type === 'error' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-[#3E2723] text-white border-white/10'
        }`}>
          {toast.type === 'error' ? <AlertCircle size={18} /> : <CheckCircle2 className="text-emerald-400" size={18} />}
          {toast.msg}
        </div>
      )}
    </div>
  );
}
