<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dapur Ghania - Hantaran & Hampers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }

        .modal { display: none; }
        .modal.active { display: flex; }
        #loader { display: none; }
        #toast { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .hidden { display: none; }
        
        .product-card { 
            transition: all 0.3s ease; 
            border: 1px solid #f3f4f6;
            cursor: pointer;
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        
        .category-tab.active { background-color: #ea580c; color: white; border-color: transparent; }

        @media (max-width: 640px) {
            .product-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .product-card img { height: 140px; }
        }
    </style>
</head>
<body class="bg-[#FFFAF5] text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white/90 backdrop-blur-md border-b border-orange-100 p-3 md:p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-orange-800 flex items-center gap-2">
                <i class="fas fa-gift text-orange-600"></i> Dapur Ghania
            </h1>
            <div class="flex items-center gap-2 md:gap-6">
                <button onclick="toggleCart()" class="relative p-2 text-orange-800 hover:bg-orange-50 rounded-full transition">
                    <i class="fas fa-shopping-bag text-lg md:text-xl"></i>
                    <span id="cart-count" class="absolute top-0 right-0 bg-orange-600 text-white text-[10px] font-bold rounded-full h-4 w-4 md:h-5 md:w-5 flex items-center justify-center border-2 border-white">0</span>
                </button>
                <div id="auth-section"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6 min-h-screen">
        <div class="flex flex-nowrap overflow-x-auto gap-2 mb-8 no-scrollbar pb-2">
            <button onclick="filterCategory('Semua')" class="category-tab active whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs md:text-sm font-semibold transition" data-cat="Semua">Semua</button>
            <button onclick="filterCategory('Paket Simple')" class="category-tab whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs md:text-sm font-semibold transition text-gray-600" data-cat="Paket Simple">Paket Simple</button>
            <button onclick="filterCategory('Paket Exclusive')" class="category-tab whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs md:text-sm font-semibold transition text-gray-600" data-cat="Paket Exclusive">Paket Exclusive</button>
        </div>

        <div id="product-list" class="product-grid grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] items-center justify-end">
        <div class="bg-white h-full w-full max-w-md p-5 flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-orange-900">Checkout</h3>
                <button onclick="toggleCart()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="cart-view-items" class="flex-1 flex flex-col overflow-hidden">
                <div id="cart-items" class="flex-1 overflow-y-auto space-y-3"></div>
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between font-bold text-lg mb-4">
                        <span>Total:</span> <span id="cart-total">Rp 0</span>
                    </div>
                    <button onclick="goToCheckoutView()" class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold">Isi Data Pengiriman</button>
                </div>
            </div>

            <div id="cart-view-form" class="flex-1 hidden flex flex-col overflow-hidden">
                <button onclick="backToCartItems()" class="text-xs text-orange-600 mb-4 font-bold flex items-center gap-2"><i class="fas fa-arrow-left"></i> Kembali</button>
                <div class="flex-1 overflow-y-auto space-y-3 pr-1 pb-4">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Informasi Pemesan</label>
                    <input type="text" id="checkout-name" placeholder="Nama Lengkap" class="w-full p-3 bg-gray-50 rounded-xl border">
                    <input type="tel" id="checkout-phone" placeholder="No. WhatsApp (Contoh: 0812...)" class="w-full p-3 bg-gray-50 rounded-xl border">
                    
                    <label class="text-[10px] font-bold text-gray-400 uppercase mt-2 block">Jadwal Pengiriman</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="checkout-date" class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="time" id="checkout-time" class="w-full p-3 bg-gray-50 rounded-xl border">
                    </div>

                    <label class="text-[10px] font-bold text-gray-400 uppercase mt-2 block">Metode & Alamat</label>
                    <select id="checkout-method" onchange="toggleAddressField()" class="w-full p-3 bg-gray-50 rounded-xl border">
                        <option value="kirim">Kirim (Kurir)</option>
                        <option value="ambil">Ambil Sendiri</option>
                    </select>
                    <textarea id="checkout-address" placeholder="Alamat Lengkap Pengiriman..." class="w-full p-3 bg-gray-50 rounded-xl border"></textarea>
                    
                    <label class="text-[10px] font-bold text-gray-400 uppercase mt-2 block">Pembayaran</label>
                    <select id="checkout-payment-type" class="w-full p-3 bg-orange-50 rounded-xl font-bold border-orange-200 border">
                        <option value="Full Payment">Lunas (100%)</option>
                        <option value="DP 50%">DP (50%)</option>
                    </select>
                    
                    <textarea id="checkout-note" placeholder="Catatan (Opsional)..." class="w-full p-3 bg-gray-50 rounded-xl border"></textarea>
                </div>
                <button onclick="confirmCheckout()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mt-2">
                    <i class="fab fa-whatsapp"></i> Konfirmasi & Kirim Pesanan
                </button>
            </div>
        </div>
    </div>

    <!-- UI Elements -->
    <div id="detail-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-2xl overflow-hidden flex flex-col md:flex-row relative">
            <button onclick="closeDetail()" class="absolute top-4 right-4 z-10 bg-white/80 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
            <div class="w-full md:w-1/2 h-48 md:h-auto overflow-hidden">
                <img id="detail-img" src="" class="w-full h-full object-cover">
            </div>
            <div class="w-full md:w-1/2 p-6 flex flex-col">
                <h3 id="detail-name" class="text-xl font-bold mb-2"></h3>
                <p id="detail-desc" class="text-gray-500 text-xs mb-4"></p>
                <div id="detail-price" class="text-xl font-bold text-orange-600 mb-4"></div>
                <button id="detail-add-btn" class="bg-orange-600 text-white px-6 py-3 rounded-xl font-bold">Tambah ke Keranjang</button>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-[100] flex items-center justify-center">
        <div class="animate-spin text-orange-600 text-4xl"><i class="fas fa-spinner"></i></div>
    </div>
    <div id="toast" class="bg-orange-950 text-white px-6 py-3 rounded-full text-sm font-bold shadow-xl"></div>

<script>
    // URL Google App Script Anda
    const GSHEET_URL = "https://script.google.com/macros/s/AKfycbxXg5qsCX7joBR8DEB2d1pW4ApqPYKpKYIkN9BhIBNxNNzbzW-LTJzRgC2EgC-YmQ1Z6w/exec";
    
    let cart = [];
    let currentCategory = 'Semua';
    let auth;
    let isFirebaseReady = false;

    // Firebase Init
    const firebaseConfig = {
        apiKey: "AIzaSyCgzjHOF5qTfevqRAMNdpLl5oPzrb02onM",
        authDomain: "dapur-ghania.firebaseapp.com",
        projectId: "dapur-ghania",
        appId: "1:745922887760:web:41c5cf27ed90bb403f9155"
    };

    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        isFirebaseReady = true;
    } catch (e) { console.warn("Firebase offline mode."); }

    // Mock Products
    const products = [];
    const categories = ["Paket Simple", "Paket Exclusive", "Kue Satuan"];
    for(let i=1; i<=12; i++) {
        products.push({
            id: i,
            category: categories[i % 3],
            name: i % 2 === 0 ? `Hampers Classic ${i}` : `Paket Hantaran ${i}`,
            price: (i * 15000) + 35000,
            img: `https://picsum.photos/seed/ghania${i}/500/500`,
            desc: `Produk spesial dari Dapur Ghania. Higienis, enak, dan dikemas cantik.`
        });
    }

    function renderProducts() {
        const container = document.getElementById('product-list');
        const filtered = currentCategory === 'Semua' ? products : products.filter(p => p.category === currentCategory);
        container.innerHTML = filtered.map(p => `
            <div onclick="openDetail(${p.id})" class="product-card bg-white rounded-2xl overflow-hidden shadow-sm">
                <img src="${p.img}" class="w-full aspect-square object-cover">
                <div class="p-3">
                    <h3 class="text-[11px] font-bold truncate">${p.name}</h3>
                    <p class="text-orange-600 font-bold text-[11px] mt-1">Rp ${p.price.toLocaleString()}</p>
                </div>
            </div>
        `).join('');
    }

    function addToCart(id) {
        const item = products.find(p => p.id === id);
        const existing = cart.find(c => c.id === id);
        if(existing) existing.qty++; else cart.push({...item, qty: 1});
        updateUI();
        showToast("Ditambahkan!");
    }

    function updateUI() {
        document.getElementById('cart-count').innerText = cart.reduce((a, b) => a + b.qty, 0);
        document.getElementById('cart-total').innerText = `Rp ${cart.reduce((a, b) => a + (b.price * b.qty), 0).toLocaleString()}`;
        const container = document.getElementById('cart-items');
        container.innerHTML = cart.map(c => `
            <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                <img src="${c.img}" class="w-10 h-10 rounded object-cover shadow-sm">
                <div class="flex-1 text-[11px] font-bold">${c.name}</div>
                <div class="flex items-center gap-2">
                    <button onclick="changeQty(${c.id},-1)" class="w-6 h-6 bg-white border rounded">-</button>
                    <span class="text-xs">${c.qty}</span>
                    <button onclick="changeQty(${c.id},1)" class="w-6 h-6 bg-white border rounded">+</button>
                </div>
            </div>
        `).join('');
    }

    function changeQty(id, d) {
        const i = cart.findIndex(c => c.id === id);
        cart[i].qty += d;
        if(cart[i].qty <= 0) cart.splice(i, 1);
        updateUI();
    }

    function goToCheckoutView() {
        if(cart.length === 0) return showToast("Pilih produk dulu!");
        document.getElementById('cart-view-items').classList.add('hidden');
        document.getElementById('cart-view-form').classList.remove('hidden');
    }

    function backToCartItems() {
        document.getElementById('cart-view-items').classList.remove('hidden');
        document.getElementById('cart-view-form').classList.add('hidden');
    }

    // --- FUNGSI UTAMA: FIX DATA SESUAI APP SCRIPT ---
    async function confirmCheckout() {
        // Ambil Value dari Form
        const name = document.getElementById('checkout-name').value;
        const phone = document.getElementById('checkout-phone').value;
        const date = document.getElementById('checkout-date').value;
        const time = document.getElementById('checkout-time').value;
        const method = document.getElementById('checkout-method').value;
        const address = document.getElementById('checkout-address').value;
        const payment_type = document.getElementById('checkout-payment-type').value;
        const note = document.getElementById('checkout-note').value;

        // Validasi Dasar
        if(!name || !phone) return showToast("Nama & WhatsApp wajib diisi!");

        setLoading(true);

        // Data Dinamis
        const items_summary = cart.map(c => `${c.name} (x${c.qty})`).join(", ");
        const total_price = cart.reduce((a, b) => a + (b.price * b.qty), 0);
        const user_id = (isFirebaseReady && auth.currentUser) ? auth.currentUser.uid : "Guest";
        const email = (isFirebaseReady && auth.currentUser) ? auth.currentUser.email : "";

        /** * SESUAIKAN DENGAN STRUKTUR doPost(e) di App Script:
         * data.name, data.phone, data.date, data.time, data.payment_type,
         * data.address, data.items, data.total, data.note, data.user_id, data.email
         */
        const formData = new URLSearchParams();
        formData.append('name', name);              // Kolom B
        formData.append('phone', phone);            // Kolom C
        formData.append('date', date);              // Kolom D
        formData.append('time', time);              // Kolom E
        formData.append('payment_type', payment_type); // Kolom F
        formData.append('address', method === 'ambil' ? 'Ambil di Toko' : address); // Kolom G
        formData.append('items', items_summary);    // Kolom H
        formData.append('total', total_price);      // Kolom I
        formData.append('note', note || "-");       // Kolom J
        formData.append('user_id', user_id);        // Kolom K
        formData.append('email', email);            // Kolom L

        try {
            // 1. Kirim ke Google Sheets (Database)
            // Menggunakan mode 'no-cors' agar request tidak diblokir browser
            await fetch(GSHEET_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: formData 
            });

            // 2. Siapkan Pesan WhatsApp (Konfirmasi ke Admin)
            const waAdminMsg = `*PESANAN BARU - DAPUR GHANIA*\n` +
                               `-------------------------\n` +
                               `Nama: ${name}\n` +
                               `WA: ${phone}\n` +
                               `Item: ${items_summary}\n` +
                               `Total: Rp ${total_price.toLocaleString()}\n` +
                               `Metode: ${method}\n` +
                               `Alamat: ${address || 'Ambil Sendiri'}\n` +
                               `Jadwal: ${date}, ${time}`;

            // 3. Redirect ke WhatsApp
            window.open(`https://wa.me/62895334016084?text=${encodeURIComponent(waAdminMsg)}`, '_blank');
            
            // 4. Reset Aplikasi
            cart = [];
            updateUI();
            toggleCart();
            backToCartItems();
            showToast("Sukses! Membuka WhatsApp...");
        } catch (e) {
            console.error(e);
            showToast("Gagal terhubung ke database. Coba lagi.");
        }
        setLoading(false);
    }

    // Modal Helpers
    function toggleCart() { document.getElementById('cart-modal').classList.toggle('active'); }
    function openDetail(id) {
        const p = products.find(x => x.id === id);
        document.getElementById('detail-img').src = p.img;
        document.getElementById('detail-name').innerText = p.name;
        document.getElementById('detail-desc').innerText = p.desc;
        document.getElementById('detail-price').innerText = `Rp ${p.price.toLocaleString()}`;
        document.getElementById('detail-add-btn').onclick = () => { addToCart(p.id); closeDetail(); };
        document.getElementById('detail-modal').classList.add('active');
    }
    function closeDetail() { document.getElementById('detail-modal').classList.remove('active'); }
    function filterCategory(cat) {
        currentCategory = cat;
        document.querySelectorAll('.category-tab').forEach(b => b.classList.toggle('active', b.dataset.cat === cat));
        renderProducts();
    }
    function setLoading(v) { document.getElementById('loader').style.display = v ? 'flex' : 'none'; }
    function showToast(m) {
        const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }
    function toggleAddressField() {
        document.getElementById('checkout-address').classList.toggle('hidden', document.getElementById('checkout-method').value === 'ambil');
    }

    renderProducts();
</script>
</body>
</html>
