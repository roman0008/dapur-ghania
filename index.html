import React, { useState, useEffect, useMemo } from 'react';
import { 
  ShoppingBasket, 
  UserCircle, 
  UserCheck, 
  X, 
  Plus, 
  Minus, 
  History, 
  Home, 
  ShieldCheck, 
  ArrowLeft, 
  Utensils,
  Clock,
  MapPin,
  MessageCircle,
  Sparkles,
  Loader2,
  Trash2
} from 'lucide-react';

// --- Constants & Config ---
// URL dari Apps Script yang Anda deploy
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEPas8ooQvo9h23axzh-dr9lUMUIjavVUinh2zCu-4f44PgOeIqSY35pBPNqvXajSLpA/exec";

/** * PERBAIKAN: ADMIN_WA harus sama persis dengan ADMIN_LOGIN_ID di Apps Script (62895...) 
 * karena Apps Script membandingkan string mentah untuk loginAdmin.
 */
const ADMIN_WA = "62895334016084"; 
const apiKey = ""; // Managed by environment

const PRODUCTS = [
  { id: 301, name: "Nasi Campur Spesial", price: 25000, category: "Nasi", img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400" },
  { id: 302, name: "Ayam Bakar Madu", price: 22000, category: "Ayam", img: "https://images.unsplash.com/photo-1599487488170-d11ec9c172f0?w=400" },
  { id: 303, name: "Snack Box Arisan", price: 12500, category: "Snack", img: "https://images.unsplash.com/photo-1563729784474-d77dbb933a9e?w=400" },
  { id: 304, name: "Tumpeng Mini", price: 35000, category: "Nasi", img: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400" },
  { id: 305, name: "Kue Hantaran Exclusive", price: 150000, category: "Hantaran", img: "https://images.unsplash.com/photo-1535141192574-5d4897c12636?w=400" },
  { id: 306, name: "Hampers Lebaran", price: 250000, category: "Hampers", img: "https://images.unsplash.com/photo-1544487079-158e8585bdca?w=400" }
];

// --- Utilities ---
const formatIDR = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);

/** * Utility untuk memastikan input nomor HP dari user dikonversi ke format 62 
 * agar cocok dengan ADMIN_LOGIN_ID di backend.
 */
const normalizePhone = (num) => {
  let clean = num.toString().replace(/\D/g, '');
  if (clean.startsWith('0')) clean = '62' + clean.substring(1);
  if (clean.startsWith('8')) clean = '62' + clean;
  if (!clean.startsWith('62')) clean = '62' + clean;
  return clean;
};

export default function App() {
  // State
  const [currentPage, setCurrentPage] = useState('home');
  const [user, setUser] = useState(JSON.parse(localStorage.getItem('ghania_user')) || null);
  const [cart, setCart] = useState([]);
  const [isAuthOpen, setIsAuthOpen] = useState(false);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [loaderText, setLoaderText] = useState('Memproses...');
  const [toast, setToast] = useState(null);
  const [history, setHistory] = useState([]);
  const [adminOrders, setAdminOrders] = useState([]);
  const [aiRecommendation, setAiRecommendation] = useState("");
  const [isAiLoading, setIsAiLoading] = useState(false);

  // Form States
  const [authData, setAuthData] = useState({ phone: '', pin: '', name: '', mode: 'login' });
  const [checkoutData, setCheckoutData] = useState({ 
    tgl: '', jam: '', bayar: 'Transfer Bank', alamat: '', catatan: '' 
  });

  // Effects
  useEffect(() => {
    if (user) {
      localStorage.setItem('ghania_user', JSON.stringify(user));
      if (currentPage === 'history') fetchUserHistory();
      if (currentPage === 'admin' && user.phone === ADMIN_WA) fetchAdminOrders();
    } else {
      localStorage.removeItem('ghania_user');
    }
  }, [user, currentPage]);

  const showToast = (msg) => {
    setToast(msg);
    setTimeout(() => setToast(null), 3000);
  };

  // --- Gemini AI Integration ---
  const getAiRecommendation = async () => {
    setIsAiLoading(true);
    const prompt = `Anda adalah asisten kuliner Dapur Ghania. Berikan 1 kalimat rekomendasi singkat dan menarik untuk menu hari ini yang terdiri dari: ${PRODUCTS.map(p => p.name).join(', ')}. Gunakan nada yang ramah dan menggugah selera (Bahasa Indonesia).`;
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const result = await response.json();
      setAiRecommendation(result.candidates?.[0]?.content?.parts?.[0]?.text || "Menu spesial menanti Anda hari ini!");
    } catch (err) {
      setAiRecommendation("Nasi Campur Spesial kami sedang jadi favorit pelanggan!");
    } finally {
      setIsAiLoading(false);
    }
  };

  useEffect(() => {
    getAiRecommendation();
  }, []);

  // --- Auth Logic ---
  const handleAuth = async () => {
    if (!authData.phone || !authData.pin || (authData.mode === 'register' && !authData.name)) {
      alert("Mohon lengkapi semua field.");
      return;
    }

    setIsLoading(true);
    setLoaderText("Autentikasi...");

    const cleanPhone = normalizePhone(authData.phone);

    try {
      // PERBAIKAN: Logic pemilihan action agar sesuai dengan variabel di backend
      let action = authData.mode; // 'login' atau 'register'
      if (authData.mode === 'login' && cleanPhone === ADMIN_WA) {
        action = 'loginAdmin';
      }

      // Gunakan JSONP pattern karena Apps Script menggunakan callback parameter di backend Anda
      const callbackName = 'ghania_callback_' + Math.round(Math.random() * 1000000);
      
      const script = document.createElement('script');
      script.src = `${SCRIPT_URL}?action=${action}&phone=${cleanPhone}&pin=${authData.pin}&name=${encodeURIComponent(authData.name)}&callback=${callbackName}`;
      
      window[callbackName] = (res) => {
        if (res.success) {
          setUser({ phone: cleanPhone, name: res.name || authData.name || "Administrator" });
          setIsAuthOpen(false);
          showToast(`Selamat datang, ${res.name || authData.name || "Admin"}!`);
        } else {
          alert(res.message || "Gagal Autentikasi");
        }
        delete window[callbackName];
        document.body.removeChild(script);
        setIsLoading(false);
      };

      document.body.appendChild(script);

    } catch (e) {
      setIsLoading(false);
      alert("Koneksi gagal. Pastikan Backend aktif.");
    }
  };

  // --- Cart & Order Logic ---
  const addToCart = (product) => {
    setCart(prev => {
      const existing = prev.find(item => item.id === product.id);
      if (existing) return prev.map(item => item.id === product.id ? { ...item, qty: item.qty + 1 } : item);
      return [...prev, { ...product, qty: 1 }];
    });
    showToast(`${product.name} ditambahkan!`);
  };

  const adjustQty = (id, delta) => {
    setCart(prev => prev.map(item => item.id === id ? { ...item, qty: Math.max(0, item.qty + delta) } : item).filter(item => item.qty > 0));
  };

  const subtotal = useMemo(() => cart.reduce((acc, item) => acc + (item.price * item.qty), 0), [cart]);
  const shippingDiscount = subtotal >= 50000 ? 10000 : 0;
  const memberDiscount = localStorage.getItem('ghania_has_ordered') === 'true' ? Math.floor(subtotal * 0.05) : 0;
  const total = subtotal - shippingDiscount - memberDiscount;

  const submitOrder = async () => {
    if (!checkoutData.tgl || !checkoutData.alamat) return alert("Lengkapi tanggal kirim dan alamat!");
    
    setIsLoading(true);
    setLoaderText("Mengirim Pesanan...");

    const payload = {
      name: user.name,
      phone: user.phone,
      date: checkoutData.tgl,
      time: checkoutData.jam,
      payment_type: checkoutData.bayar,
      address: checkoutData.alamat,
      note: checkoutData.catatan,
      total: total,
      items: cart.map(i => `${i.name} (${i.qty}x)`).join(" | ") // Gunakan separator sesuai backend
    };

    try {
      const formData = new URLSearchParams();
      Object.keys(payload).forEach(key => formData.append(key, payload[key]));

      await fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });

      localStorage.setItem('ghania_has_ordered', 'true');
      const waMsg = `Halo Dapur Ghania, saya *${payload.name}* memesan:\n${cart.map(i => `- ${i.name} x${i.qty}`).join('\n')}\n\nTotal: *${formatIDR(total)}*\nAlamat: ${payload.address}`;
      window.open(`https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(waMsg)}`, '_blank');
      
      setCart([]);
      setIsCheckoutOpen(false);
      showToast("Pesanan berhasil dikirim!");
      setCurrentPage('history');
    } catch (e) {
      alert("Terjadi kesalahan saat mengirim pesanan.");
    } finally {
      setIsLoading(false);
    }
  };

  // --- Fetchers (Updated with JSONP for compatibility) ---
  const fetchData = (params) => {
    return new Promise((resolve) => {
      const callbackName = 'ghania_fetch_' + Math.round(Math.random() * 1000000);
      const script = document.createElement('script');
      script.src = `${SCRIPT_URL}?${params}&callback=${callbackName}`;
      window[callbackName] = (res) => {
        resolve(res);
        delete window[callbackName];
        document.body.removeChild(script);
      };
      document.body.appendChild(script);
    });
  };

  const fetchUserHistory = async () => {
    const res = await fetchData(`action=getOrders&phone=${user.phone}`);
    if (res.success) setHistory(res.data || []);
  };

  const fetchAdminOrders = async () => {
    const res = await fetchData(`action=getAllOrders`);
    if (res.success) setAdminOrders(res.data || []);
  };

  return (
    <div className="min-h-screen bg-[#FFFAF5] text-slate-800 font-sans selection:bg-orange-100">
      
      {/* --- Loader Overlay --- */}
      {isLoading && (
        <div className="fixed inset-0 z-[999] bg-black/40 backdrop-blur-sm flex items-center justify-center">
          <div className="bg-white p-8 rounded-[2rem] shadow-2xl flex flex-col items-center gap-4">
            <Loader2 className="w-10 h-10 text-orange-600 animate-spin" />
            <p className="text-[10px] font-black uppercase tracking-widest text-slate-400">{loaderText}</p>
          </div>
        </div>
      )}

      {/* --- Toast --- */}
      {toast && (
        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[800] bg-slate-900 text-white px-6 py-3 rounded-2xl text-xs font-bold shadow-xl animate-bounce">
          {toast}
        </div>
      )}

      {/* --- Header --- */}
      <header className="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-orange-100 px-4 py-3">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <div>
            <h1 className="text-xl font-black text-orange-800 tracking-tighter leading-none">DAPUR GHANIA</h1>
            <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">
              {user ? `Halo, ${user.name.split(' ')[0]}` : 'Premium Catering Service'}
            </p>
          </div>
          <div className="flex items-center gap-2">
            {!user ? (
              <button onClick={() => setIsAuthOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all">
                <UserCircle size={18} className="text-slate-600" />
                <span className="text-[10px] font-black uppercase tracking-wider text-slate-600">Login</span>
              </button>
            ) : (
              <button 
                onClick={() => { if(window.confirm('Keluar akun?')) setUser(null); }}
                className="flex items-center gap-2 px-4 py-2 bg-orange-50 hover:bg-orange-100 rounded-xl transition-all"
              >
                <UserCheck size={18} className="text-orange-600" />
                <span className="text-[10px] font-black uppercase tracking-wider text-orange-600">Logout</span>
              </button>
            )}
            <button 
              onClick={() => setIsCartOpen(true)}
              className="relative p-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-xl shadow-lg shadow-orange-200 transition-all active:scale-90"
            >
              <ShoppingBasket size={20} />
              {cart.length > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-[9px] font-black w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">
                  {cart.reduce((a, b) => a + b.qty, 0)}
                </span>
              )}
            </button>
          </div>
        </div>

        {/* --- Navigation Tabs --- */}
        {user && (
          <nav className="max-w-4xl mx-auto flex gap-6 mt-4 border-t border-slate-50 pt-2 overflow-x-auto scrollbar-hide">
            {[
              { id: 'home', icon: Home, label: 'Home' },
              { id: 'history', icon: History, label: 'Riwayat' },
              ...(user.phone === ADMIN_WA ? [{ id: 'admin', icon: ShieldCheck, label: 'Admin' }] : [])
            ].map(tab => (
              <button 
                key={tab.id}
                onClick={() => setCurrentPage(tab.id)}
                className={`flex items-center gap-1.5 py-2 px-1 text-[10px] font-black uppercase tracking-widest transition-all border-b-2 ${
                  currentPage === tab.id ? 'text-orange-600 border-orange-600' : 'text-slate-400 border-transparent'
                }`}
              >
                <tab.icon size={14} />
                {tab.label}
              </button>
            ))}
          </nav>
        )}
      </header>

      {/* --- Main Content --- */}
      <main className="max-w-4xl mx-auto p-4 pb-32">
        {currentPage === 'home' && (
          <section className="animate-in fade-in slide-in-from-bottom-4 duration-700">
            {/* Hero Card */}
            <div className="bg-gradient-to-br from-orange-500 to-orange-700 rounded-[2.5rem] p-8 text-white relative overflow-hidden shadow-2xl shadow-orange-100 mb-8">
              <div className="relative z-10 max-w-sm">
                <h2 className="text-3xl font-black leading-tight tracking-tighter uppercase mb-2">Hantaran & Hampers Exclusive</h2>
                <div className="flex items-center gap-2 bg-white/20 backdrop-blur-md w-fit px-3 py-1 rounded-full text-[10px] font-bold">
                  <Sparkles size={12} />
                  DISKON MEMBER 5%
                </div>
              </div>
              <Utensils className="absolute -right-8 -bottom-8 w-48 h-48 text-white/10 rotate-12" />
            </div>

            {/* AI Recommendation Box */}
            <div className="bg-white border-2 border-orange-100 rounded-3xl p-5 mb-8 flex items-start gap-4 shadow-sm">
              <div className="bg-orange-100 p-3 rounded-2xl text-orange-600">
                <Sparkles size={24} />
              </div>
              <div>
                <h4 className="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-1">AI Suggestion</h4>
                {isAiLoading ? (
                  <div className="flex gap-2 items-center"><Loader2 size={12} className="animate-spin" /> <span className="text-xs text-slate-400">Thinking...</span></div>
                ) : (
                  <p className="text-sm font-bold italic text-slate-700 leading-relaxed">"{aiRecommendation}"</p>
                )}
              </div>
            </div>

            {/* Product Grid */}
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              {PRODUCTS.map(product => (
                <div key={product.id} className="group bg-white rounded-[2rem] overflow-hidden border border-slate-100 shadow-sm hover:shadow-xl transition-all hover:-translate-y-1">
                  <div className="relative h-40 overflow-hidden">
                    <img src={product.img} alt={product.name} className="w-full h-full object-cover transition-transform group-hover:scale-110" />
                    <div className="absolute top-3 left-3 px-2 py-1 bg-white/90 backdrop-blur-md rounded-lg text-[8px] font-black uppercase tracking-tighter text-slate-500">
                      {product.category}
                    </div>
                  </div>
                  <div className="p-4">
                    <h3 className="font-bold text-xs text-slate-800 h-8 line-clamp-2">{product.name}</h3>
                    <p className="text-orange-600 font-black text-sm mt-1">{formatIDR(product.price)}</p>
                    <button 
                      onClick={() => addToCart(product)}
                      className="w-full mt-4 py-2.5 bg-orange-50 hover:bg-orange-600 text-orange-600 hover:text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                    >
                      Beli Sekarang
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {currentPage === 'history' && (
          <section className="space-y-4 animate-in slide-in-from-right-4 duration-500">
            <h2 className="text-2xl font-black tracking-tighter uppercase mb-6">Riwayat Pesanan</h2>
            {history.length === 0 ? (
              <div className="bg-white rounded-[2.5rem] p-12 text-center border-2 border-dashed border-slate-100">
                <History className="w-12 h-12 text-slate-200 mx-auto mb-4" />
                <p className="text-slate-400 font-bold text-sm">Belum ada pesanan.</p>
              </div>
            ) : (
              history.map((order, idx) => (
                <div key={idx} className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-[10px] font-black text-orange-600 uppercase">{order.invoice}</span>
                      <span className={`px-2 py-0.5 rounded-full text-[8px] font-black uppercase ${order.status_bayar === 'Lunas' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                        {order.status_bayar}
                      </span>
                    </div>
                    <p className="text-xs font-bold text-slate-400 mb-2">{order.date}</p>
                    <p className="text-xs text-slate-600 font-medium line-clamp-1">{order.items}</p>
                  </div>
                  <div className="flex items-center justify-between md:flex-col md:items-end gap-2">
                    <p className="text-lg font-black text-slate-800">{formatIDR(parseInt(order.total))}</p>
                    {order.pdf !== '-' && (
                      <a href={order.pdf} target="_blank" className="text-[9px] font-black text-blue-600 uppercase flex items-center gap-1 hover:underline">
                        Download Invoice <Plus size={10} />
                      </a>
                    )}
                  </div>
                </div>
              ))
            )}
          </section>
        )}

        {currentPage === 'admin' && (
          <section className="animate-in slide-in-from-left-4 duration-500">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-black tracking-tighter text-red-600 uppercase">Admin Dashboard</h2>
              <button onClick={fetchAdminOrders} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-[10px] font-bold uppercase">Refresh Data</button>
            </div>
            <div className="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-xl">
              <div className="overflow-x-auto">
                <table className="w-full text-left text-xs">
                  <thead className="bg-slate-50 border-b border-slate-100">
                    <tr>
                      <th className="p-4 font-black uppercase tracking-widest text-slate-400 text-[9px]">Invoice</th>
                      <th className="p-4 font-black uppercase tracking-widest text-slate-400 text-[9px]">Customer</th>
                      <th className="p-4 font-black uppercase tracking-widest text-slate-400 text-[9px]">Total</th>
                      <th className="p-4 font-black uppercase tracking-widest text-slate-400 text-[9px]">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-50">
                    {adminOrders.map((order, idx) => (
                      <tr key={idx} className="hover:bg-slate-50 transition-colors">
                        <td className="p-4 font-bold text-orange-600">{order.invoice}</td>
                        <td className="p-4">
                          <p className="font-bold text-slate-800">{order.name}</p>
                          <p className="text-[10px] text-slate-400 font-medium">{order.phone}</p>
                        </td>
                        <td className="p-4 font-black">{formatIDR(parseInt(order.total))}</td>
                        <td className="p-4">
                          <select 
                            className="bg-slate-100 p-2 rounded-xl font-bold text-[10px] border-none outline-none focus:ring-2 focus:ring-orange-500"
                            defaultValue={order.status_bayar}
                            onChange={async (e) => {
                              setIsLoading(true);
                              await fetchData(`action=updateStatus&rowId=${order.rowId}&status=${e.target.value}`);
                              setIsLoading(false);
                              showToast("Status diperbarui");
                            }}
                          >
                            <option value="Belum Bayar">❌ Belum</option>
                            <option value="Lunas">✅ Lunas</option>
                          </select>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        )}
      </main>

      {/* --- Auth Modal --- */}
      {isAuthOpen && (
        <div className="fixed inset-0 z-[1000] bg-slate-900/60 backdrop-blur-xl flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl relative animate-in zoom-in duration-300">
            <button onClick={() => setIsAuthOpen(false)} className="absolute top-8 right-8 text-slate-300 hover:text-slate-600 transition-colors">
              <X size={24} />
            </button>
            <div className="text-center mb-8">
              <h3 className="text-2xl font-black text-orange-800 tracking-tighter uppercase">Dapur Ghania</h3>
              <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Akses Member Exclusive</p>
            </div>
            
            <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
              {['login', 'register'].map(m => (
                <button 
                  key={m}
                  onClick={() => setAuthData({...authData, mode: m})}
                  className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${
                    authData.mode === m ? 'bg-white shadow-sm text-orange-600' : 'text-slate-500'
                  }`}
                >
                  {m === 'login' ? 'Masuk' : 'Daftar'}
                </button>
              ))}
            </div>

            <div className="space-y-3">
              {authData.mode === 'register' && (
                <input 
                  type="text" 
                  placeholder="Nama Lengkap" 
                  className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                  value={authData.name}
                  onChange={e => setAuthData({...authData, name: e.target.value})}
                />
              )}
              <input 
                type="tel" 
                placeholder="Nomor WhatsApp" 
                className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                value={authData.phone}
                onChange={e => setAuthData({...authData, phone: e.target.value})}
              />
              <input 
                type="password" 
                placeholder="PIN Keamanan (6 Digit)" 
                className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-sm focus:ring-2 focus:ring-orange-500 outline-none"
                value={authData.pin}
                onChange={e => setAuthData({...authData, pin: e.target.value})}
              />
              <button 
                onClick={handleAuth}
                className="w-full bg-orange-600 hover:bg-orange-700 text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-orange-100 transition-all active:scale-95 mt-4"
              >
                KONFIRMASI AKUN
              </button>
            </div>
          </div>
        </div>
      )}

      {/* --- Cart Modal --- */}
      {isCartOpen && (
        <div className="fixed inset-0 z-[1000] bg-slate-900/40 backdrop-blur-sm flex items-end md:items-center justify-center p-4">
          <div className="bg-white w-full max-w-md rounded-t-[3rem] md:rounded-[3rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in slide-in-from-bottom-10">
            <div className="p-6 border-b border-orange-50 bg-orange-50 flex justify-between items-center">
              <div>
                <h3 className="text-xl font-black text-orange-900 tracking-tighter">KERANJANG SAYA</h3>
                <p className="text-[9px] font-bold text-orange-400 uppercase tracking-widest">Siap untuk dipesan</p>
              </div>
              <button onClick={() => setIsCartOpen(false)} className="text-orange-900 bg-white/50 p-2 rounded-full hover:bg-white transition-all"><X size={20} /></button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-6 space-y-4">
              {cart.length === 0 ? (
                <div className="py-20 text-center opacity-30 flex flex-col items-center">
                  <ShoppingBasket size={48} className="mb-2" />
                  <p className="text-sm font-black uppercase">Kosong</p>
                </div>
              ) : (
                cart.map(item => (
                  <div key={item.id} className="flex items-center gap-4 bg-slate-50/50 p-4 rounded-[1.5rem] border border-slate-50 hover:border-orange-100 transition-all">
                    <img src={item.img} className="w-16 h-16 rounded-xl object-cover shadow-sm" alt={item.name} />
                    <div className="flex-1">
                      <h4 className="font-bold text-xs text-slate-800 leading-tight">{item.name}</h4>
                      <p className="text-[10px] font-black text-orange-600 mt-1">{formatIDR(item.price)}</p>
                    </div>
                    <div className="flex items-center gap-3 bg-white px-3 py-1.5 rounded-xl border border-slate-100 shadow-sm">
                      <button onClick={() => adjustQty(item.id, -1)} className="text-slate-400 hover:text-orange-600"><Minus size={14} /></button>
                      <span className="text-xs font-black w-4 text-center">{item.qty}</span>
                      <button onClick={() => adjustQty(item.id, 1)} className="text-slate-400 hover:text-orange-600"><Plus size={14} /></button>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="p-8 bg-white border-t border-slate-100 space-y-3">
              <div className="space-y-1.5">
                <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                  <span>Subtotal</span>
                  <span>{formatIDR(subtotal)}</span>
                </div>
                {shippingDiscount > 0 && (
                  <div className="flex justify-between text-[10px] font-black text-green-600 uppercase tracking-wider">
                    <span>Subsidi Ongkir</span>
                    <span>-{formatIDR(shippingDiscount)}</span>
                  </div>
                )}
                {memberDiscount > 0 && (
                  <div className="flex justify-between text-[10px] font-black text-blue-600 uppercase tracking-wider">
                    <span>Loyalty Discount (5%)</span>
                    <span>-{formatIDR(memberDiscount)}</span>
                  </div>
                )}
              </div>
              <div className="pt-3 border-t border-slate-50 flex justify-between items-center mb-6">
                <span className="font-black text-slate-800 tracking-tighter uppercase">Total Akhir</span>
                <span className="text-2xl font-black text-orange-600 tracking-tighter">{formatIDR(total)}</span>
              </div>
              <button 
                disabled={cart.length === 0}
                onClick={() => {
                  if(!user) { setIsCartOpen(false); setIsAuthOpen(true); showToast("Harap login dahulu!"); }
                  else { setIsCartOpen(false); setIsCheckoutOpen(true); }
                }}
                className="w-full bg-slate-900 disabled:bg-slate-200 text-white py-4 rounded-2xl font-black text-sm uppercase tracking-widest shadow-xl active:scale-95 transition-all"
              >
                PROSES CHECKOUT
              </button>
            </div>
          </div>
        </div>
      )}

      {/* --- Checkout Form Modal --- */}
      {isCheckoutOpen && (
        <div className="fixed inset-0 z-[1001] bg-white flex flex-col md:inset-auto md:fixed md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-xl md:h-[90vh] md:rounded-[3rem] md:shadow-2xl overflow-hidden animate-in zoom-in duration-300">
          <div className="p-6 border-b flex items-center gap-4 bg-orange-50">
            <button onClick={() => setIsCheckoutOpen(false)} className="bg-white p-2 rounded-full text-orange-800 shadow-sm"><ArrowLeft size={20} /></button>
            <div>
              <h2 className="text-lg font-black text-orange-900 tracking-tighter uppercase leading-none">KONFIRMASI PENGIRIMAN</h2>
              <p className="text-[9px] font-bold text-orange-400 uppercase tracking-widest">Detail Pesanan Dapur Ghania</p>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-8 space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-1.5">
                <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-1"><Clock size={10} /> Tanggal & Waktu Kirim</label>
                <div className="grid grid-cols-2 gap-2">
                  <input type="date" className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-xs outline-none focus:ring-2 focus:ring-orange-500" value={checkoutData.tgl} onChange={e => setCheckoutData({...checkoutData, tgl: e.target.value})} />
                  <input type="time" className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-xs outline-none focus:ring-2 focus:ring-orange-500" value={checkoutData.jam} onChange={e => setCheckoutData({...checkoutData, jam: e.target.value})} />
                </div>
              </div>
              <div className="space-y-1.5">
                <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-1"><ShieldCheck size={10} /> Metode Bayar</label>
                <select className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-xs outline-none focus:ring-2 focus:ring-orange-500" value={checkoutData.bayar} onChange={e => setCheckoutData({...checkoutData, bayar: e.target.value})}>
                  <option value="Transfer Bank">Transfer Bank</option>
                  <option value="DP 50%">DP 50% (Sisa COD)</option>
                  <option value="Full Payment">Lunas (Full Payment)</option>
                </select>
              </div>
            </div>

            <div className="space-y-1.5">
              <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-1"><MapPin size={10} /> Alamat Lengkap Pengiriman</label>
              <textarea rows="3" placeholder="Sebutkan patokan rumah / gedung..." className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-xs outline-none focus:ring-2 focus:ring-orange-500" value={checkoutData.alamat} onChange={e => setCheckoutData({...checkoutData, alamat: e.target.value})}></textarea>
            </div>

            <div className="space-y-1.5">
              <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-1"><MessageCircle size={10} /> Catatan Tambahan (Opsional)</label>
              <input type="text" placeholder="Contoh: Kurangi pedas / Tanpa MSG" className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-xs outline-none focus:ring-2 focus:ring-orange-500" value={checkoutData.catatan} onChange={e => setCheckoutData({...checkoutData, catatan: e.target.value})} />
            </div>

            <div className="bg-orange-50 p-6 rounded-[2rem] border border-orange-100">
              <h4 className="text-[10px] font-black text-orange-900 uppercase tracking-widest mb-4">Ringkasan Pesanan</h4>
              <div className="space-y-2 mb-4">
                {cart.map(i => (
                  <div key={i.id} className="flex justify-between text-xs font-bold text-slate-600">
                    <span>{i.name} x{i.qty}</span>
                    <span>{formatIDR(i.price * i.qty)}</span>
                  </div>
                ))}
              </div>
              <div className="flex justify-between items-center pt-3 border-t border-orange-200">
                <span className="font-black text-orange-900 uppercase text-[10px]">Grand Total</span>
                <span className="text-xl font-black text-orange-600">{formatIDR(total)}</span>
              </div>
            </div>
          </div>

          <div className="p-8 bg-white border-t border-slate-100">
            <button 
              onClick={submitOrder}
              className="w-full bg-green-600 hover:bg-green-700 text-white py-5 rounded-[2rem] font-black text-sm shadow-xl shadow-green-100 flex items-center justify-center gap-3 transition-all active:scale-95"
            >
              <MessageCircle size={20} />
              KIRIM PESANAN KE WHATSAPP
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
